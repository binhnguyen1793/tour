<?php
/**
 * Template for taxonomy page: vung_mien_combo
 * URL: /vung_mien_combo/[slug]/
 */

get_header();
$term = get_queried_object();

// Get filters from URL
$khoi_hanh = isset($_GET['khoihanh']) ? sanitize_text_field($_GET['khoihanh']) : '';
$thoi_gian = isset($_GET['thoigian']) ? sanitize_text_field($_GET['thoigian']) : '';
$order = isset($_GET['order']) ? sanitize_text_field($_GET['order']) : '';

$args = [
    'post_type' => 'combo',
    'posts_per_page' => -1,
    'tax_query' => [
        [
            'taxonomy' => 'vung_mien_combo',
            'field' => 'slug',
            'terms' => $term->slug
        ]
    ],
    'meta_query' => []
];

if ($khoi_hanh) {
    $args['meta_query'][] = [
        'key' => 'khoihanh',
        'value' => $khoi_hanh,
        'compare' => '='
    ];
}

if ($thoi_gian) {
    $args['meta_query'][] = [
        'key' => 'thoi_gian',
        'value' => $thoi_gian,
        'compare' => '='
    ];
}

if ($order == 'gia_tang') {
    $args['orderby'] = 'meta_value_num';
    $args['meta_key'] = 'gia_tour';
    $args['order'] = 'ASC';
} elseif ($order == 'gia_giam') {
    $args['orderby'] = 'meta_value_num';
    $args['meta_key'] = 'gia_tour';
    $args['order'] = 'DESC';
} elseif ($order == 'danh_gia') {
    $args['orderby'] = 'meta_value_num';
    $args['meta_key'] = 'danh_gia';
    $args['order'] = 'DESC';
}

$query = new WP_Query($args);
?>

<div class="container" style="display:flex;gap:24px">
  <!-- Bộ lọc -->
  <aside style="width:250px;border:1px solid #ddd;padding:16px;border-radius:8px">
    <h3 style="color:#007bff;font-size:18px;margin-bottom:16px">\ud83d\udd0d Bộ lọc</h3>
    <form method="get">
      <h4>Khởi hành từ</h4>
      <label><input type="checkbox" name="khoihanh" value="Ha Noi" <?= ($khoi_hanh == 'Ha Noi' ? 'checked' : '') ?>> Hà Nội</label>

      <hr>
      <h4>Thời gian combo</h4>
      <label><input type="checkbox" name="thoigian" value="2 ngày 1 đêm" <?= ($thoi_gian == '2 ngày 1 đêm' ? 'checked' : '') ?>> 2 ngày 1 đêm</label><br>
      <label><input type="checkbox" name="thoigian" value="3 ngày 2 đêm" <?= ($thoi_gian == '3 ngày 2 đêm' ? 'checked' : '') ?>> 3 ngày 2 đêm</label>

      <button type="submit" style="margin-top:16px;padding:6px 12px;background:#e1703a;color:white;border:none;border-radius:6px">Lọc</button>
    </form>
  </aside>

  <!-- Danh sách combo -->
  <div style="flex:1">
    <h2 style="font-size:20px;margin-bottom:16px">Top combo du lịch <?php echo esc_html($term->name); ?></h2>

    <!-- Sort -->
    <div style="margin-bottom:20px">
      <span><strong>Sắp xếp:</strong></span>
      <a href="?order=">BestPrice đề xuất</a> |
      <a href="?order=gia_tang">Giá: Thấp đến cao</a> |
      <a href="?order=gia_giam">Giá: Cao đến thấp</a> |
      <a href="?order=danh_gia">Đánh giá</a>
    </div>

    <?php
    if ($query->have_posts()):
      echo '<div style="display:flex;flex-wrap:wrap;gap:20px">';
      while ($query->have_posts()): $query->the_post();
        echo do_shortcode('[combo_card id="' . get_the_ID() . '"]');
      endwhile;
      echo '</div>';
    else:
      echo '<p>Không tìm thấy combo phù hợp.</p>';
    endif;
    wp_reset_postdata();
    ?>
  </div>
</div>

<?php get_footer(); ?>
